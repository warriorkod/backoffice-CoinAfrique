"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const path = require("path");
const spawn = require('cross-spawn');
const scriptsIndexHtml = `
<!-- Comment this out, *if* using differential loading or es2015 as a target in Angular 8+ -->
<script src="./assets/webcomponentsjs/custom-elements-es5-adapter.js"></script>

`;
const scriptsPolyfills = `
if (!window['customElements']) {
  const script = document.createElement('script');
  script.src = './assets/webcomponentsjs/bundles/webcomponents-sd-ce.js';
  document.writeln(script.outerHTML);
}
`;
function npmInstall(options) {
    return function (tree, context) {
        spawn.sync('npm', ['install', options.package, options.switch], { stdio: 'inherit' });
        return tree;
    };
}
function npmRun(options) {
    return function (tree, context) {
        spawn.sync('npm', ['run', options.script], { stdio: 'inherit' });
        return tree;
    };
}
exports.npmRun = npmRun;
function executeNodeScript(options) {
    const scriptName = options.script;
    return (tree, _context) => {
        spawn.sync('node', [scriptName], { stdio: 'inherit' });
    };
}
exports.executeNodeScript = executeNodeScript;
function addWebComponentsPolyfill(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign({}, _options, { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        const rule = schematics_1.chain([
            updateIndexHtml(_options),
            updatePolyfills(_options),
            updatePackageJson(project.root || '', _options),
            schematics_1.branchAndMerge(schematics_1.mergeWith(templateSource)),
        ]);
        const packageJson = loadPackageJson(tree);
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/custom-elements']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/custom-elements',
            }));
        }
        if (!packageJson['dependencies'] || !packageJson['dependencies']['@webcomponents/webcomponentsjs']) {
            _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: '@webcomponents/webcomponentsjs',
            }));
        }
        if ((!packageJson['dependencies'] || !packageJson['dependencies']['copy'])
            && (!packageJson['devDependencies'] || !packageJson['devDependencies']['copy'])) {
            const id = _context.addTask(new tasks_1.NodePackageInstallTask({
                packageName: 'copy',
            }));
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }), [id]);
        }
        else {
            _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'npx-build-plus:copy-assets' }));
        }
        return rule(tree, _context);
    };
}
exports.addWebComponentsPolyfill = addWebComponentsPolyfill;
function updatePackageJson(path, _options) {
    return (tree, context) => {
        const config = loadPackageJson(tree);
        updateScripts(path, config, tree, _options);
        savePackageJson(config, tree);
        return tree;
    };
}
function updateIndexHtml(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/index.html`;
        const indexHtml = tree.read(fileName);
        if (indexHtml === null)
            throw Error('could not read index.html');
        const contentAsString = indexHtml.toString('UTF-8');
        if (contentAsString.includes('native-shim.js')) {
            console.info('Seems like, webcomponent polyfills are already referenced by index.html');
            return;
        }
        const modifiedContent = contentAsString.replace('</body>', scriptsIndexHtml + '\n</body>');
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function updatePolyfills(options) {
    return (tree, context) => {
        const project = getProject(tree, options);
        const fileName = `${project.sourceRoot}/polyfills.ts`;
        const polyfillsJs = tree.read(fileName);
        if (polyfillsJs === null)
            throw Error('could not read polyfills.ts');
        const contentAsString = polyfillsJs.toString('UTF-8');
        if (contentAsString.includes('webcomponents-loader.js')) {
            console.info('Seems like, webcomponents-loader is already referenced by polyfill.js');
            return;
        }
        const modifiedContent = contentAsString + '\n\n' + scriptsPolyfills;
        tree.overwrite(fileName, modifiedContent);
        return tree;
    };
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options) {
    const script = `node ${path}copy-wc-polyfill.js`;
    if (!config['scripts']) {
        config.scripts = {};
    }
    let currentScript = config.scripts['npx-build-plus:copy-assets'];
    if (!currentScript) {
        currentScript = script;
    }
    else if (!currentScript.includes(script)) {
        currentScript += ' && ' + script;
    }
    config.scripts['npx-build-plus:copy-assets'] = currentScript;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3Mvd2ViY29tcG9uZW50cy1wb2x5ZmlsbC9pbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLDJEQUF3STtBQUN4SSwrREFBa0U7QUFDbEUsNERBQTRGO0FBQzVGLDZCQUE2QjtBQUU3QixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7QUFFckMsTUFBTSxnQkFBZ0IsR0FBRzs7OztDQUl4QixDQUFBO0FBRUQsTUFBTSxnQkFBZ0IsR0FBRzs7Ozs7O0NBTXhCLENBQUM7QUFFRixTQUFTLFVBQVUsQ0FBQyxPQUFZO0lBQzlCLE9BQU8sVUFBVSxJQUFVLEVBQUUsT0FBeUI7UUFDcEQsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDLE9BQU8sRUFBRSxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUN0RixPQUFPLElBQUksQ0FBQztJQUNkLENBQUMsQ0FBQTtBQUNILENBQUM7QUFFRCxTQUFnQixNQUFNLENBQUMsT0FBWTtJQUNqQyxPQUFPLFVBQVUsSUFBVSxFQUFFLE9BQXlCO1FBQ3BELEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQyxDQUFBO0FBQ0gsQ0FBQztBQUxELHdCQUtDO0FBRUQsU0FBZ0IsaUJBQWlCLENBQUMsT0FBWTtJQUM1QyxNQUFNLFVBQVUsR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDO0lBQ2xDLE9BQU8sQ0FBQyxJQUFVLEVBQUUsUUFBMEIsRUFBRSxFQUFFO1FBQ2hELEtBQUssQ0FBQyxJQUFJLENBQUMs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QUV6RSxJQUFJLENBQUMsYUFBYSxFQUFFO1FBQ2xCLGFBQWEsR0FBRyxNQUFNLENBQUM7S0FDeEI7U0FDSSxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRTtRQUN4QyxhQUFhLElBQUksTUFBTSxHQUFHLE1BQU0sQ0FBQztLQUNsQztJQUVELE1BQU0sQ0FBQyxPQUFPLENBQUMsNEJBQTRCLENBQUMsR0FBRyxhQUFhLENBQUM7QUFDL0QsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJ1bGUsIFNjaGVtYXRpY0NvbnRleHQsIFRyZWUsIGFwcGx5LCB1cmwsIHRlbXBsYXRlLCBtb3ZlLCBicmFuY2hBbmRNZXJnZSwgbWVyZ2VXaXRoLCBjaGFpbiB9IGZyb20gJ0Bhbmd1bGFyLWRldmtpdC9zY2hlbWF0aWNzJztcclxuaW1wb3J0IHsgZ2V0V29ya3NwYWNlIH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L2NvbmZpZyc7XHJcbmltcG9ydCB7IFJ1blNjaGVtYXRpY1Rhc2ssIE5vZGVQYWNrYWdlSW5zdGFsbFRhc2sgfSBmcm9tICdAYW5ndWxhci1kZXZraXQvc2NoZW1hdGljcy90YXNrcyc7XHJcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XHJcblxyXG5jb25zdCBzcGF3biA9IHJlcXVpcmUoJ2Nyb3NzLXNwYXduJyk7XHJcblxyXG5jb25zdCBzY3JpcHRzSW5kZXhIdG1sID0gYFxyXG48IS0tIENvbW1lbnQgdGhpcyBvdXQsICppZiogdXNpbmcgZGlmZmVyZW50aWFsIGxvYWRpbmcgb3IgZXMyMDE1IGFzIGEgdGFyZ2V0IGluIEFuZ3VsYXIgOCsgLS0+XHJcbjxzY3JpcHQgc3JjPVwiLi9hc3NldHMvd2ViY29tcG9uZW50c2pzL2N1c3RvbS1lbGVtZW50cy1lczUtYWRhcHRlci5qc1wiPjwvc2NyaXB0PlxyXG5cclxuYFxyXG5cclxuY29uc3Qgc2NyaXB0c1BvbHlmaWxscyA9IGBcclxuaWYgKCF3aW5kb3dbJ2N1c3RvbUVsZW1lbnRzJ10pIHtcclxuICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcclxuICBzY3JpcHQuc3JjID0gJy4vYXNzZXRzL3dlYmNvbXBvbmVudHNqcy9idW5kbGVzL3dlYmNvbXBvbmVudHMtc2QtY2UuanMnO1xyXG4gIGRvY3VtZW50LndyaXRlbG4oc2NyaXB0Lm91dGVySFRNTCk7XHJcbn1cclxuYDtcclxuXHJcbmZ1bmN0aW9uIG5wbUluc3RhbGwob3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuIGZ1bmN0aW9uICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSB7XHJcbiAgICBzcGF3bi5zeW5jKCducG0nLCBbJ2luc3RhbGwnLCBvcHRpb25zLnBhY2thZ2UsIG9wdGlvbnMuc3dpdGNoXSwgeyBzdGRpbzogJ2luaGVyaXQnIH0pO1xyXG4gICAgcmV0dXJuIHRyZWU7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbnBtUnVuKG9wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiBmdW5jdGlvbiAodHJlZTogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkge1xyXG4gICAgc3Bhd24uc3luYygnbnBtJywgWydydW4nLCBvcHRpb25zLnNjcmlwdF0sIHsgc3RkaW86ICdpbmhlcml0JyB9KTtcclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4ZWN1dGVOb2RlU2NyaXB0KG9wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIGNvbnN0IHNjcmlwdE5hbWUgPSBvcHRpb25zLnNjcmlwdDtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIF9jb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcbiAgICBzcGF3bi5zeW5jKCdub2RlJywgW3NjcmlwdE5hbWVdLCB7IHN0ZGlvOiAnaW5oZXJpdCcgfSk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWRkV2ViQ29tcG9uZW50c1BvbHlmaWxsKF9vcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIF9jb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcblxyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgX29wdGlvbnMpO1xyXG5cclxuICAgIGNvbnN0IHJlbFByb2plY3RSb290UGF0aCA9XHJcbiAgICAgIHByb2plY3Qucm9vdC5yZXBsYWNlKC9bXlxcL10rL2csICcuLicpIHx8ICcnO1xyXG5cclxuICAgIGNvbnN0IHRlbXBsYXRlU291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzJyksIFtcclxuICAgICAgdGVtcGxhdGUoeyAuLi5fb3B0aW9ucywgcmVsUHJvamVjdFJvb3RQYXRoLCBwcm9qZWN0Um9vdDogcHJvamVjdC5yb290IHx8ICcnIH0pLFxyXG4gICAgICBtb3ZlKHByb2plY3Qucm9vdCB8fCAnLycpXHJcbiAgICBdKTtcclxuXHJcbiAgICBjb25zdCBydWxlID0gY2hhaW4oW1xyXG4gICAgICB1cGRhdGVJbmRleEh0bWwoX29wdGlvbnMpLFxyXG4gICAgICB1cGRhdGVQb2x5ZmlsbHMoX29wdGlvbnMpLFxyXG4gICAgICB1cGRhdGVQYWNrYWdlSnNvbihwcm9qZWN0LnJvb3QgfHwgJycsIF9vcHRpb25zKSxcclxuICAgICAgYnJhbmNoQW5kTWVyZ2UobWVyZ2VXaXRoKHRlbXBsYXRlU291cmNlKSksXHJcbiAgICAgIC8vIG5wbUluc3RhbGwoe3BhY2thZ2U6ICdAd2ViY29tcG9uZW50cy9jdXN0b20tZWxlbWVudHMnLCBzd2l0Y2g6ICctLXNhdmUnfSksXHJcbiAgICAgIC8vIG5wbUluc3RhbGwoe3BhY2thZ2U6ICdjb3B5Jywgc3dpdGNoOiAnLS1zYXZlLWRldid9KSxcclxuICAgIF0pO1xyXG5cclxuICAgIGNvbnN0IHBhY2thZ2VKc29uID0gbG9hZFBhY2thZ2VKc29uKHRyZWUpO1xyXG5cclxuICAgIGlmICghcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ11bJ0B3ZWJjb21wb25lbnRzL2N1c3RvbS1lbGVtZW50cyddKSB7XHJcbiAgICAgIF9jb250ZXh0LmFkZFRhc2sobmV3IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2soe1xyXG4gICAgICAgIHBhY2thZ2VOYW1lOiAnQHdlYmNvbXBvbmVudHMvY3VzdG9tLWVsZW1lbnRzJyxcclxuICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghcGFja2FnZUpzb25bJ2RlcGVuZGVuY2llcyddIHx8ICFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ11bJ0B3ZWJjb21wb25lbnRzL3dlYmNvbXBvbmVudHNqcyddKSB7XHJcbiAgICAgIF9jb250ZXh0LmFkZFRhc2sobmV3IE5vZGVQYWNrYWdlSW5zdGFsbFRhc2soe1xyXG4gICAgICAgIHBhY2thZ2VOYW1lOiAnQHdlYmNvbXBvbmVudHMvd2ViY29tcG9uZW50c2pzJyxcclxuICAgICAgfSkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChcclxuICAgICAgKCFwYWNrYWdlSnNvblsnZGVwZW5kZW5jaWVzJ10gfHwgIXBhY2thZ2VKc29uWydkZXBlbmRlbmNpZXMnXVsnY29weSddKVxyXG4gICAgICAmJiAoIXBhY2thZ2VKc29uWydkZXZEZXBlbmRlbmNpZXMnXSB8fCAhcGFja2FnZUpzb25bJ2RldkRlcGVuZGVuY2llcyddWydjb3B5J10pXHJcbiAgICApIHtcclxuXHJcbiAgICAgIGNvbnN0IGlkID0gX2NvbnRleHQuYWRkVGFzayhuZXcgTm9kZVBhY2thZ2VJbnN0YWxsVGFzayh7XHJcbiAgICAgICAgcGFja2FnZU5hbWU6ICdjb3B5JyxcclxuICAgICAgfSkpO1xyXG5cclxuICAgICAgX2NvbnRleHQuYWRkVGFzayhuZXcgUnVuU2NoZW1hdGljVGFzaygnbnBtUnVuJywgeyBzY3JpcHQ6ICducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cycgfSksIFtpZF0pO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIF9jb250ZXh0LmFkZFRhc2sobmV3IFJ1blNjaGVtYXRpY1Rhc2soJ25wbVJ1bicsIHsgc2NyaXB0OiAnbnB4LWJ1aWxkLXBsdXM6Y29weS1hc3NldHMnIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gcnVsZSh0cmVlLCBfY29udGV4dCk7XHJcbiAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUGFja2FnZUpzb24ocGF0aDogc3RyaW5nLCBfb3B0aW9uczogYW55KTogUnVsZSB7XHJcbiAgcmV0dXJuICh0cmVlOiBUcmVlLCBjb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcbiAgICBjb25zdCBjb25maWcgPSBsb2FkUGFja2FnZUpzb24odHJlZSk7XHJcbiAgICB1cGRhdGVTY3JpcHRzKHBhdGgsIGNvbmZpZywgdHJlZSwgX29wdGlvbnMpO1xyXG4gICAgc2F2ZVBhY2thZ2VKc29uKGNvbmZpZywgdHJlZSk7XHJcbiAgICByZXR1cm4gdHJlZTtcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZUluZGV4SHRtbChvcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIGNvbnRleHQ6IFNjaGVtYXRpY0NvbnRleHQpID0+IHtcclxuICAgIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIG9wdGlvbnMpO1xyXG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHtwcm9qZWN0LnNvdXJjZVJvb3R9L2luZGV4Lmh0bWxgO1xyXG5cclxuICAgIGNvbnN0IGluZGV4SHRtbCA9IHRyZWUucmVhZChmaWxlTmFtZSk7XHJcbiAgICBpZiAoaW5kZXhIdG1sID09PSBudWxsKVxyXG4gICAgICB0aHJvdyBFcnJvcignY291bGQgbm90IHJlYWQgaW5kZXguaHRtbCcpO1xyXG4gICAgY29uc3QgY29udGVudEFzU3RyaW5nID0gaW5kZXhIdG1sLnRvU3RyaW5nKCdVVEYtOCcpO1xyXG5cclxuICAgIGlmIChjb250ZW50QXNTdHJpbmcuaW5jbHVkZXMoJ25hdGl2ZS1zaGltLmpzJykpIHtcclxuICAgICAgY29uc29sZS5pbmZvKCdTZWVtcyBsaWtlLCB3ZWJjb21wb25lbnQgcG9seWZpbGxzIGFyZSBhbHJlYWR5IHJlZmVyZW5jZWQgYnkgaW5kZXguaHRtbCcpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgbW9kaWZpZWRDb250ZW50ID0gY29udGVudEFzU3RyaW5nLnJlcGxhY2UoJzwvYm9keT4nLCBzY3JpcHRzSW5kZXhIdG1sICsgJ1xcbjwvYm9keT4nKTtcclxuXHJcbiAgICB0cmVlLm92ZXJ3cml0ZShmaWxlTmFtZSwgbW9kaWZpZWRDb250ZW50KTtcclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUG9seWZpbGxzKG9wdGlvbnM6IGFueSk6IFJ1bGUge1xyXG4gIHJldHVybiAodHJlZTogVHJlZSwgY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkgPT4ge1xyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgb3B0aW9ucyk7XHJcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke3Byb2plY3Quc291cmNlUm9vdH0vcG9seWZpbGxzLnRzYDtcclxuXHJcbiAgICBjb25zdCBwb2x5ZmlsbHNKcyA9IHRyZWUucmVhZChmaWxlTmFtZSk7XHJcbiAgICBpZiAocG9seWZpbGxzSnMgPT09IG51bGwpXHJcbiAgICAgIHRocm93IEVycm9yKCdjb3VsZCBub3QgcmVhZCBwb2x5ZmlsbHMudHMnKTtcclxuICAgIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IHBvbHlmaWxsc0pzLnRvU3RyaW5nKCdVVEYtOCcpO1xyXG5cclxuICAgIGlmIChjb250ZW50QXNTdHJpbmcuaW5jbHVkZXMoJ3dlYmNvbXBvbmVudHMtbG9hZGVyLmpzJykpIHtcclxuICAgICAgY29uc29sZS5pbmZvKCdTZWVtcyBsaWtlLCB3ZWJjb21wb25lbnRzLWxvYWRlciBpcyBhbHJlYWR5IHJlZmVyZW5jZWQgYnkgcG9seWZpbGwuanMnKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG1vZGlmaWVkQ29udGVudCA9IGNvbnRlbnRBc1N0cmluZyArICdcXG5cXG4nICsgc2NyaXB0c1BvbHlmaWxscztcclxuXHJcbiAgICB0cmVlLm92ZXJ3cml0ZShmaWxlTmFtZSwgbW9kaWZpZWRDb250ZW50KTtcclxuICAgIHJldHVybiB0cmVlO1xyXG4gIH1cclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGdldFByb2plY3QodHJlZTogVHJlZSwgb3B0aW9uczogYW55KSB7XHJcbiAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKHRyZWUpO1xyXG4gIGlmICghb3B0aW9ucy5wcm9qZWN0KSB7XHJcbiAgICBvcHRpb25zLnByb2plY3QgPSBPYmplY3Qua2V5cyh3b3Jrc3BhY2UucHJvamVjdHMpWzBdO1xyXG4gIH1cclxuICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMucHJvamVjdF07XHJcblxyXG4gIC8vIGNvbXBlbnNhdGUgZm9yIGxhY2tpbmcgc291cmNlUm9vdCBwcm9wZXJ0eVxyXG4gIC8vIGUuIGcuIHdoZW4gcHJvamVjdCB3YXMgbWlncmF0ZWQgdG8gbmc3LCBzb3VyY2VSb290IGlzIGxhY2tpbmdcclxuICBpZiAoIXByb2plY3Quc291cmNlUm9vdCAmJiAhcHJvamVjdC5yb290KSB7XHJcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSAnc3JjJztcclxuICB9XHJcbiAgZWxzZSBpZiAoIXByb2plY3Quc291cmNlUm9vdCkge1xyXG4gICAgcHJvamVjdC5zb3VyY2VSb290ID0gcGF0aC5qb2luKHByb2plY3Qucm9vdCwgJ3NyYycpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHByb2plY3Q7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNhdmVQYWNrYWdlSnNvbihjb25maWc6IGFueSwgdHJlZTogVHJlZSkge1xyXG4gIGNvbnN0IG5ld0NvbnRlbnRBc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KGNvbmZpZywgbnVsbCwgMikgfHwgJyc7XHJcbiAgdHJlZS5vdmVyd3JpdGUoJ3BhY2thZ2UuanNvbicsIG5ld0NvbnRlbnRBc1N0cmluZyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRQYWNrYWdlSnNvbih0cmVlOiBUcmVlKSB7XHJcbiAgY29uc3QgcGtnID0gdHJlZS5yZWFkKCdwYWNrYWdlLmpzb24nKTtcclxuICBpZiAocGtnID09PSBudWxsKVxyXG4gICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBhY2thZ2UuanNvbicpO1xyXG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IHBrZy50b1N0cmluZygnVVRGLTgnKTtcclxuICBjb25zdCBjb25maWcgPSBKU09OLnBhcnNlKGNvbnRlbnRBc1N0cmluZyk7XHJcbiAgcmV0dXJuIGNvbmZpZztcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlU2NyaXB0cyhwYXRoOiBzdHJpbmcsIGNvbmZpZzogYW55LCB0cmVlOiBUcmVlLCBfb3B0aW9uczogYW55KSB7XHJcbiAgY29uc3Qgc2NyaXB0ID0gYG5vZGUgJHtwYXRofWNvcHktd2MtcG9seWZpbGwuanNgO1xyXG5cclxuICBpZiAoIWNvbmZpZ1snc2NyaXB0cyddKSB7XHJcbiAgICBjb25maWcuc2NyaXB0cyA9IHt9O1xyXG4gIH1cclxuXHJcbiAgbGV0IGN1cnJlbnRTY3JpcHQ6IHN0cmluZyA9IGNvbmZpZy5zY3JpcHRzWyducHgtYnVpbGQtcGx1czpjb3B5LWFzc2V0cyddO1xyXG5cclxuICBpZiAoIWN1cnJlbnRTY3JpcHQpIHtcclxuICAgIGN1cnJlbnRTY3JpcHQgPSBzY3JpcHQ7XHJcbiAgfVxyXG4gIGVsc2UgaWYgKCFjdXJyZW50U2NyaXB0LmluY2x1ZGVzKHNjcmlwdCkpIHtcclxuICAgIGN1cnJlbnRTY3JpcHQgKz0gJyAmJiAnICsgc2NyaXB0O1xyXG4gIH1cclxuXHJcbiAgY29uZmlnLnNjcmlwdHNbJ25weC1idWlsZC1wbHVzOmNvcHktYXNzZXRzJ10gPSBjdXJyZW50U2NyaXB0O1xyXG59XHJcblxyXG4iXX0=