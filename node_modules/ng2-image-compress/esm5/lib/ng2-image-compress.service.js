/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ResizeOptions } from "./ResizeOptions";
import { ImageUtilityService } from "./imageUtilityService";
import { from as Observablefrom } from "rxjs";
import * as i0 from "@angular/core";
var ImageCompressService = /** @class */ (function () {
    function ImageCompressService() {
    }
    /**
     * @private
     * @param {?} sourceImgObj
     * @param {?} options
     * @return {?}
     */
    ImageCompressService.jicCompress = /**
     * @private
     * @param {?} sourceImgObj
     * @param {?} options
     * @return {?}
     */
    function (sourceImgObj, options) {
        /** @type {?} */
        var outputFormat = options.Resize_Type;
        /** @type {?} */
        var quality = options.Resize_Quality || 50;
        /** @type {?} */
        var mimeType = 'image/jpeg';
        if (outputFormat !== undefined && outputFormat === 'png') {
            mimeType = 'image/png';
        }
        /** @type {?} */
        var maxHeight = options.Resize_Max_Height || 300;
        /** @type {?} */
        var maxWidth = options.Resize_Max_Width || 250;
        console.log('MAX Width n Height');
        console.log(options.Resize_Max_Height);
        console.log(options.Resize_Max_Width);
        console.log('Quality');
        console.log(quality);
        /** @type {?} */
        var height = sourceImgObj.height;
        /** @type {?} */
        var width = sourceImgObj.width;
        // calculate the width and height, constraining the proportions
        if (width > height) {
            if (width > maxWidth) {
                height = Math.round(height *= maxWidth / width);
                width = maxWidth;
            }
        }
        else {
            if (height > maxHeight) {
                width = Math.round(width *= maxHeight / height);
                height = maxHeight;
            }
        }
        console.log('CVS Width n Height');
        console.log(width);
        console.log(height);
        console.log('Quality');
        console.log(quality);
        /** @type {?} */
        var cvs = document.createElement('canvas');
        cvs.width = width;
        cvs.height = height;
        /** @type {?} */
        var ctx = cvs.getContext('2d').drawImage(sourceImgObj, 0, 0, width, height);
        /** @type {?} */
        var newImageData = cvs.toDataURL(mimeType, quality / 100);
        /** @type {?} */
        var resultImageObj = new Image();
        resultImageObj.src = newImageData;
        return resultImageObj.src;
    };
    /**
     * @param {?} sourceImage
     * @param {?} options
     * @param {?} callback
     * @return {?}
     */
    ImageCompressService.compressImage = /**
     * @param {?} sourceImage
     * @param {?} options
     * @param {?} callback
     * @return {?}
     */
    function (sourceImage, options, callback) {
        /** @type {?} */
        var that = this;
        ImageUtilityService.createImage(sourceImage.imageDataUrl, function (image) {
            /** @type {?} */
            var dataURLcompressed = that.jicCompress(image, options);
            sourceImage.compressedImage = {
                fileName: sourceImage.fileName,
                imageObjectUrl: "",
                imageDataUrl: dataURLcompressed,
                type: dataURLcompressed.match(/:(.+\/.+);/)[1],
                compressedImage: null
            };
            callback(sourceImage);
        });
    };
    /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    ImageCompressService.filesToCompressedImageSourceEx = /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    function (fileList, option) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = fileList.length;
            /** @type {?} */
            var observer = ImageUtilityService.filesToSourceImages(fileList);
            /** @type {?} */
            var images = [];
            observer.subscribe(function (image) {
                images.push(image);
                if (option == null) {
                    option = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, option, function (imageRef) {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, function (error) {
                reject("Error while compressing images");
            });
        });
    };
    /**
     * @param {?} fileList
     * @return {?}
     */
    ImageCompressService.filesToCompressedImageSource = /**
     * @param {?} fileList
     * @return {?}
     */
    function (fileList) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = fileList.length;
            /** @type {?} */
            var observer = ImageUtilityService.filesToSourceImages(fileList);
            /** @type {?} */
            var images = [];
            observer.subscribe(function (image) {
                images.push(image);
                ImageCompressService.compressImage(image, new ResizeOptions(), function (imageRef) {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, function (error) {
                reject("Error while compressing images");
            });
        });
    };
    /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    ImageCompressService.filesArrayToCompressedImageSourceEx = /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    function (fileList, option) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = fileList.length;
            /** @type {?} */
            var observer = ImageUtilityService.filesArrayToSourceImages(fileList);
            /** @type {?} */
            var images = [];
            observer.subscribe(function (image) {
                images.push(image);
                if (option == null) {
                    option = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, option, function (imageRef) {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, function (error) {
                reject("Error while compressing images");
            });
        });
    };
    /**
     * @param {?} fileList
     * @return {?}
     */
    ImageCompressService.filesArrayToCompressedImageSource = /**
     * @param {?} fileList
     * @return {?}
     */
    function (fileList) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = fileList.length;
            /** @type {?} */
            var observer = ImageUtilityService.filesArrayToSourceImages(fileList);
            /** @type {?} */
            var images = [];
            observer.subscribe(function (image) {
                images.push(image);
                ImageCompressService.compressImage(image, new ResizeOptions(), function (imageRef) {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, function (error) {
                reject("Error while compressing images");
            });
        });
    };
    /**
     * @param {?} images
     * @return {?}
     */
    ImageCompressService.IImageListToCompressedImageSource = /**
     * @param {?} images
     * @return {?}
     */
    function (images) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = images.length;
            images.forEach(function (image) {
                ImageCompressService.compressImage(image, new ResizeOptions(), function (imageRef) {
                    console.log(image);
                    if (--count == 0) {
                        resolve(images);
                    }
                });
            });
        });
    };
    /**
     * @param {?} images
     * @param {?} resizeOption
     * @return {?}
     */
    ImageCompressService.IImageListToCompressedImageSourceEx = /**
     * @param {?} images
     * @param {?} resizeOption
     * @return {?}
     */
    function (images, resizeOption) {
        return new Promise(function (resolve, reject) {
            /** @type {?} */
            var count = images.length;
            images.forEach(function (image) {
                if (resizeOption == null) {
                    resizeOption = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, resizeOption, function (imageRef) {
                    console.log(image);
                    if (--count == 0) {
                        resolve(images);
                    }
                });
            });
        });
    };
    ImageCompressService.decorators = [
        { type: Injectable, args: [{
                    providedIn: 'root'
                },] }
    ];
    /** @nocollapse */ ImageCompressService.ngInjectableDef = i0.defineInjectable({ factory: function ImageCompressService_Factory() { return new ImageCompressService(); }, token: ImageCompressService, providedIn: "root" });
    return ImageCompressService;
}());
export { ImageCompressService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcyLWltYWdlLWNvbXByZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItaW1hZ2UtY29tcHJlc3MvIiwic291cmNlcyI6WyJsaWIvbmcyLWltYWdlLWNvbXByZXNzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRS9DLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTVELE9BQU8sRUFBRSxJQUFJLElBQUksY0FBYyxFQUFDLE1BQU0sTUFBTSxDQUFDOztBQUU3QztJQUFBO0tBZ01DOzs7Ozs7O0lBeExnQixnQ0FBVzs7Ozs7O0lBQTFCLFVBQTJCLFlBQVksRUFBRSxPQUFzQjs7WUFDdkQsWUFBWSxHQUFHLE9BQU8sQ0FBQyxXQUFXOztZQUNsQyxPQUFPLEdBQUcsT0FBTyxDQUFDLGNBQWMsSUFBSSxFQUFFOztZQUN0QyxRQUFRLEdBQUcsWUFBWTtRQUMzQixJQUFJLFlBQVksS0FBSyxTQUFTLElBQUksWUFBWSxLQUFLLEtBQUssRUFBRTtZQUN0RCxRQUFRLEdBQUcsV0FBVyxDQUFDO1NBQzFCOztZQUdHLFNBQVMsR0FBRyxPQUFPLENBQUMsaUJBQWlCLElBQUksR0FBRzs7WUFDNUMsUUFBUSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsSUFBSSxHQUFHO1FBRTlDLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1FBQ3ZDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2QixPQUFPLENBQUMsR0FBRyxDQUFDLE9B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RyxJQUFJLGFBQWEsRUFBRSxDQUFDO2lCQUN0QztnQkFDRCxvQkFBb0IsQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLFlBQVksRUFBRSxVQUFDLFFBQVE7b0JBQzdELE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ25CLElBQUksRUFBRSxLQUFLLElBQUksQ0FBQyxFQUFFO3dCQUNkLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztxQkFDbkI7Z0JBQ0wsQ0FBQyxDQUFDLENBQUM7WUFDUCxDQUFDLENBQUMsQ0FBQztRQUVQLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQzs7Z0JBOUxGLFVBQVUsU0FBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzsrQkFURDtDQXVNQyxBQWhNRCxJQWdNQztTQTVMWSxvQkFBb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7IFxuaW1wb3J0IHsgUmVzaXplT3B0aW9ucyB9IGZyb20gXCIuL1Jlc2l6ZU9wdGlvbnNcIlxuaW1wb3J0IHsgU291cmNlSW1hZ2UsIElJbWFnZSB9IGZyb20gXCIuL0NvbXByZXNzSW1hZ2VcIjtcbmltcG9ydCB7IEltYWdlVXRpbGl0eVNlcnZpY2UgfSBmcm9tIFwiLi9pbWFnZVV0aWxpdHlTZXJ2aWNlXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anNcIiBcbmltcG9ydCB7IGZyb20gYXMgT2JzZXJ2YWJsZWZyb219IGZyb20gXCJyeGpzXCI7XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuXG5leHBvcnQgY2xhc3MgSW1hZ2VDb21wcmVzc1NlcnZpY2Uge1xuXG4gIFxuXG4gIHByaXZhdGUgc3RhdGljIGppY0NvbXByZXNzKHNvdXJjZUltZ09iaiwgb3B0aW9uczogUmVzaXplT3B0aW9ucykge1xuICAgICAgdmFyIG91dHB1dEZvcm1hdCA9IG9wdGlvbnMuUmVzaXplX1R5cGU7XG4gICAgICB2YXIgcXVhbGl0eSA9IG9wdGlvbnMuUmVzaXplX1F1YWxpdHkgfHwgNTA7XG4gICAgICB2YXIgbWltZVR5cGUgPSAnaW1hZ2UvanBlZyc7XG4gICAgICBpZiAob3V0cHV0Rm9ybWF0ICE9PSB1bmRlZmluZWQgJiYgb3V0cHV0Rm9ybWF0ID09PSAncG5nJykge1xuICAgICAgICAgIG1pbWVUeXBlID0gJ2ltYWdlL3BuZyc7XG4gICAgICB9XG5cblxuICAgICAgdmFyIG1heEhlaWdodCA9IG9wdGlvbnMuUmVzaXplX01heF9IZWlnaHQgfHwgMzAwO1xuICAgICAgdmFyIG1heFdpZHRoID0gb3B0aW9ucy5SZXNpemVfTWF4X1dpZHRoIHx8IDI1MDtcblxuICAgICAgY29uc29sZS5sb2coJ01BWCBXaWR0aCBuIEhlaWdodCcpO1xuICAgICAgY29uc29sZS5sb2cob3B0aW9ucy5SZXNpemVfTWF4X0hlaWdodCk7XG4gICAgICBjb25zb2xlLmxvZyhvcHRpb25zLlJlc2l6ZV9NYXhfV2lkdGgpO1xuICAgICAgY29uc29sZS5sb2coJ1F1YWxpdHknKTtcbiAgICAgIGNvbnNvbGUubG9nKHF1YWxpdHkpO1xuXG4gICAgICB2YXIgaGVpZ2h0ID0gc291cmNlSW1nT2JqLmhlaWdodDtcbiAgICAgIHZhciB3aWR0aCA9IHNvdXJjZUltZ09iai53aWR0aDtcblxuICAgICAgLy8gY2FsY3VsYXRlIHRoZSB3aWR0aCBhbmQgaGVpZ2h0LCBjb25zdHJhaW5pbmcgdGhlIHByb3BvcnRpb25zXG4gICAgICBpZiAod2lkdGggPiBoZWlnaHQpIHtcbiAgICAgICAgICBpZiAod2lkdGggPiBtYXhXaWR0aCkge1xuICAgICAgICAgICAgICBoZWlnaHQgPSBNYXRoLnJvdW5kKGhlaWdodCAqPSBtYXhXaWR0aCAvIHdpZHRoKTtcbiAgICAgICAgICAgICAgd2lkdGggPSBtYXhXaWR0aDtcbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgICBpZiAoaGVpZ2h0ID4gbWF4SGVpZ2h0KSB7XG4gICAgICAgICAgICAgIHdpZHRoID0gTWF0aC5yb3VuZCh3aWR0aCAqPSBtYXhIZWlnaHQgLyBoZWlnaHQpO1xuICAgICAgICAgICAgICBoZWlnaHQgPSBtYXhIZWlnaHQ7XG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29uc29sZS5sb2coJ0NWUyBXaWR0aCBuIEhlaWdodCcpO1xuICAgICAgY29uc29sZS5sb2cod2lkdGgpO1xuICAgICAgY29uc29sZS5sb2coaGVpZ2h0KTtcbiAgICAgIGNvbnNvbGUubG9nKCdRdWFsaXR5Jyk7XG4gICAgICBjb25zb2xlLmxvZyhxdWFsaXR5KTtcblxuICAgICAgdmFyIGN2cyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2NhbnZhcycpO1xuICAgICAgY3ZzLndpZHRoID0gd2lkdGg7XG4gICAgICBjdnMuaGVpZ2h0ID0gaGVpZ2h0O1xuICAgICAgdmFyIGN0eCA9IGN2cy5nZXRDb250ZXh0KCcyZCcpLmRyYXdJbWFnZShzb3VyY2VJbWdPYmosIDAsIDAsIHdpZHRoLCBoZWlnaHQpO1xuICAgICAgdmFyIG5ld0ltYWdlRGF0YSA9IGN2cy50b0RhdGFVUkwobWltZVR5cGUsIHF1YWxpdHkgLyAxMDApO1xuICAgICAgdmFyIHJlc3VsdEltYWdlT2JqID0gbmV3IEltYWdlKCk7XG4gICAgICByZXN1bHRJbWFnZU9iai5zcmMgPSBuZXdJbWFnZURhdGE7XG4gICAgICByZXR1cm4gcmVzdWx0SW1hZ2VPYmouc3JjO1xuICB9XG5cbiAgIFxuXG4gIHB1YmxpYyBzdGF0aWMgY29tcHJlc3NJbWFnZShzb3VyY2VJbWFnZTogSUltYWdlLCBvcHRpb25zOiBSZXNpemVPcHRpb25zLCBjYWxsYmFjaykge1xuICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuICAgICAgSW1hZ2VVdGlsaXR5U2VydmljZS5jcmVhdGVJbWFnZShzb3VyY2VJbWFnZS5pbWFnZURhdGFVcmwsIGZ1bmN0aW9uIChpbWFnZSkge1xuICAgICAgICAgIHZhciBkYXRhVVJMY29tcHJlc3NlZCA9IHRoYXQuamljQ29tcHJlc3MoaW1hZ2UsIG9wdGlvbnMpO1xuICAgICAgICAgIHNvdXJjZUltYWdlLmNvbXByZXNzZWRJbWFnZSA9IHtcbiAgICAgICAgICAgICAgZmlsZU5hbWU6IHNvdXJjZUltYWdlLmZpbGVOYW1lLFxuICAgICAgICAgICAgICBpbWFnZU9iamVjdFVybDogXCJcIixcbiAgICAgICAgICAgICAgaW1hZ2VEYXRhVXJsOiBkYXRhVVJMY29tcHJlc3NlZCxcbiAgICAgICAgICAgICAgdHlwZTogZGF0YVVSTGNvbXByZXNzZWQubWF0Y2goLzooLitcXC8uKyk7LylbMV0sXG4gICAgICAgICAgICAgIGNvbXByZXNzZWRJbWFnZTogbnVsbFxuICAgICAgICAgIH07XG4gICAgICAgICAgY2FsbGJhY2soc291cmNlSW1hZ2UpO1xuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGZpbGVzVG9Db21wcmVzc2VkSW1hZ2VTb3VyY2VFeChmaWxlTGlzdDogRmlsZUxpc3QsIG9wdGlvbjogUmVzaXplT3B0aW9ucyk6IFByb21pc2U8T2JzZXJ2YWJsZTxJSW1hZ2U+PiB7XG5cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBsZXQgY291bnQgPSBmaWxlTGlzdC5sZW5ndGg7XG4gICAgICAgICAgbGV0IG9ic2VydmVyID0gSW1hZ2VVdGlsaXR5U2VydmljZS5maWxlc1RvU291cmNlSW1hZ2VzKGZpbGVMaXN0KTtcbiAgICAgICAgICBsZXQgaW1hZ2VzOiBBcnJheTxJSW1hZ2U+ID0gW107XG4gICAgICAgICAgb2JzZXJ2ZXIuc3Vic2NyaWJlKChpbWFnZSkgPT4ge1xuICAgICAgICAgICAgICBpbWFnZXMucHVzaChpbWFnZSk7XG4gICAgICAgICAgICAgIGlmIChvcHRpb24gPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgb3B0aW9uID0gbmV3IFJlc2l6ZU9wdGlvbnMoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBJbWFnZUNvbXByZXNzU2VydmljZS5jb21wcmVzc0ltYWdlKGltYWdlLCBvcHRpb24sIChpbWFnZVJlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgaWYgKC0tY291bnQgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoT2JzZXJ2YWJsZWZyb20oaW1hZ2VzKSk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICByZWplY3QoXCJFcnJvciB3aGlsZSBjb21wcmVzc2luZyBpbWFnZXNcIik7XG4gICAgICAgICAgfSlcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmaWxlc1RvQ29tcHJlc3NlZEltYWdlU291cmNlKGZpbGVMaXN0OiBGaWxlTGlzdCk6IFByb21pc2U8T2JzZXJ2YWJsZTxJSW1hZ2U+PiB7XG5cblxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPE9ic2VydmFibGU8SUltYWdlPj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGxldCBjb3VudCA9IGZpbGVMaXN0Lmxlbmd0aDtcbiAgICAgICAgICBsZXQgb2JzZXJ2ZXIgPSBJbWFnZVV0aWxpdHlTZXJ2aWNlLmZpbGVzVG9Tb3VyY2VJbWFnZXMoZmlsZUxpc3QpO1xuICAgICAgICAgIGxldCBpbWFnZXM6IEFycmF5PElJbWFnZT4gPSBbXTtcbiAgICAgICAgICBvYnNlcnZlci5zdWJzY3JpYmUoKGltYWdlKSA9PiB7XG4gICAgICAgICAgICAgIGltYWdlcy5wdXNoKGltYWdlKTtcblxuICAgICAgICAgICAgICBJbWFnZUNvbXByZXNzU2VydmljZS5jb21wcmVzc0ltYWdlKGltYWdlLCBuZXcgUmVzaXplT3B0aW9ucygpLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKE9ic2VydmFibGVmcm9tKGltYWdlcykpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KFwiRXJyb3Igd2hpbGUgY29tcHJlc3NpbmcgaW1hZ2VzXCIpO1xuICAgICAgICAgIH0pXG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZmlsZXNBcnJheVRvQ29tcHJlc3NlZEltYWdlU291cmNlRXgoZmlsZUxpc3Q6IEZpbGVbXSwgb3B0aW9uOiBSZXNpemVPcHRpb25zKTogUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+IHtcblxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPE9ic2VydmFibGU8SUltYWdlPj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGxldCBjb3VudCA9IGZpbGVMaXN0Lmxlbmd0aDtcbiAgICAgICAgICBsZXQgb2JzZXJ2ZXIgPSBJbWFnZVV0aWxpdHlTZXJ2aWNlLmZpbGVzQXJyYXlUb1NvdXJjZUltYWdlcyhmaWxlTGlzdCk7XG4gICAgICAgICAgbGV0IGltYWdlczogQXJyYXk8SUltYWdlPiA9IFtdO1xuICAgICAgICAgIG9ic2VydmVyLnN1YnNjcmliZSgoaW1hZ2UpID0+IHtcbiAgICAgICAgICAgICAgaW1hZ2VzLnB1c2goaW1hZ2UpO1xuICAgICAgICAgICAgICBpZiAob3B0aW9uID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIG9wdGlvbiA9IG5ldyBSZXNpemVPcHRpb25zKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgb3B0aW9uLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKE9ic2VydmFibGVmcm9tKGltYWdlcykpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KFwiRXJyb3Igd2hpbGUgY29tcHJlc3NpbmcgaW1hZ2VzXCIpO1xuICAgICAgICAgIH0pXG4gICAgICB9KTtcbiAgfVxuICBwdWJsaWMgc3RhdGljIGZpbGVzQXJyYXlUb0NvbXByZXNzZWRJbWFnZVNvdXJjZShmaWxlTGlzdDogRmlsZVtdKTogUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+IHtcblxuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPE9ic2VydmFibGU8SUltYWdlPj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGxldCBjb3VudCA9IGZpbGVMaXN0Lmxlbmd0aDtcbiAgICAgICAgICBsZXQgb2JzZXJ2ZXIgPSBJbWFnZVV0aWxpdHlTZXJ2aWNlLmZpbGVzQXJyYXlUb1NvdXJjZUltYWdlcyhmaWxlTGlzdCk7XG4gICAgICAgICAgbGV0IGltYWdlczogQXJyYXk8SUltYWdlPiA9IFtdO1xuICAgICAgICAgIG9ic2VydmVyLnN1YnNjcmliZSgoaW1hZ2UpID0+IHtcbiAgICAgICAgICAgICAgaW1hZ2VzLnB1c2goaW1hZ2UpO1xuICAgICAgICAgICAgICBJbWFnZUNvbXByZXNzU2VydmljZS5jb21wcmVzc0ltYWdlKGltYWdlLCBuZXcgUmVzaXplT3B0aW9ucygpLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKE9ic2VydmFibGVmcm9tKGltYWdlcykpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KFwiRXJyb3Igd2hpbGUgY29tcHJlc3NpbmcgaW1hZ2VzXCIpO1xuICAgICAgICAgIH0pXG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgSUltYWdlTGlzdFRvQ29tcHJlc3NlZEltYWdlU291cmNlKGltYWdlczogSUltYWdlW10pOiBQcm9taXNlPElJbWFnZVtdPiB7XG5cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJSW1hZ2VbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGxldCBjb3VudCA9IGltYWdlcy5sZW5ndGg7XG4gICAgICAgICAgaW1hZ2VzLmZvckVhY2goaW1hZ2UgPT4ge1xuICAgICAgICAgICAgICBJbWFnZUNvbXByZXNzU2VydmljZS5jb21wcmVzc0ltYWdlKGltYWdlLCBuZXcgUmVzaXplT3B0aW9ucygpLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGltYWdlKTtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGltYWdlcyk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuXG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgSUltYWdlTGlzdFRvQ29tcHJlc3NlZEltYWdlU291cmNlRXgoaW1hZ2VzOiBJSW1hZ2VbXSwgcmVzaXplT3B0aW9uOiBSZXNpemVPcHRpb25zKTogUHJvbWlzZTxJSW1hZ2VbXT4ge1xuICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPElJbWFnZVtdPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgbGV0IGNvdW50ID0gaW1hZ2VzLmxlbmd0aDtcbiAgICAgICAgICBpbWFnZXMuZm9yRWFjaChpbWFnZSA9PiB7XG4gICAgICAgICAgICAgIGlmIChyZXNpemVPcHRpb24gPT0gbnVsbCkge1xuICAgICAgICAgICAgICAgICAgcmVzaXplT3B0aW9uID0gbmV3IFJlc2l6ZU9wdGlvbnMoKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICBJbWFnZUNvbXByZXNzU2VydmljZS5jb21wcmVzc0ltYWdlKGltYWdlLCByZXNpemVPcHRpb24sIChpbWFnZVJlZikgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coaW1hZ2UpO1xuICAgICAgICAgICAgICAgICAgaWYgKC0tY291bnQgPT0gMCkge1xuICAgICAgICAgICAgICAgICAgICAgIHJlc29sdmUoaW1hZ2VzKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSk7XG5cbiAgICAgIH0pO1xuICB9XG5cbn1cblxuIl19