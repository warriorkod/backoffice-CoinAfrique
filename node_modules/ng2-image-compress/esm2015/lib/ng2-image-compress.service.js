/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import { Injectable } from '@angular/core';
import { ResizeOptions } from "./ResizeOptions";
import { ImageUtilityService } from "./imageUtilityService";
import { from as Observablefrom } from "rxjs";
import * as i0 from "@angular/core";
export class ImageCompressService {
    /**
     * @private
     * @param {?} sourceImgObj
     * @param {?} options
     * @return {?}
     */
    static jicCompress(sourceImgObj, options) {
        /** @type {?} */
        var outputFormat = options.Resize_Type;
        /** @type {?} */
        var quality = options.Resize_Quality || 50;
        /** @type {?} */
        var mimeType = 'image/jpeg';
        if (outputFormat !== undefined && outputFormat === 'png') {
            mimeType = 'image/png';
        }
        /** @type {?} */
        var maxHeight = options.Resize_Max_Height || 300;
        /** @type {?} */
        var maxWidth = options.Resize_Max_Width || 250;
        console.log('MAX Width n Height');
        console.log(options.Resize_Max_Height);
        console.log(options.Resize_Max_Width);
        console.log('Quality');
        console.log(quality);
        /** @type {?} */
        var height = sourceImgObj.height;
        /** @type {?} */
        var width = sourceImgObj.width;
        // calculate the width and height, constraining the proportions
        if (width > height) {
            if (width > maxWidth) {
                height = Math.round(height *= maxWidth / width);
                width = maxWidth;
            }
        }
        else {
            if (height > maxHeight) {
                width = Math.round(width *= maxHeight / height);
                height = maxHeight;
            }
        }
        console.log('CVS Width n Height');
        console.log(width);
        console.log(height);
        console.log('Quality');
        console.log(quality);
        /** @type {?} */
        var cvs = document.createElement('canvas');
        cvs.width = width;
        cvs.height = height;
        /** @type {?} */
        var ctx = cvs.getContext('2d').drawImage(sourceImgObj, 0, 0, width, height);
        /** @type {?} */
        var newImageData = cvs.toDataURL(mimeType, quality / 100);
        /** @type {?} */
        var resultImageObj = new Image();
        resultImageObj.src = newImageData;
        return resultImageObj.src;
    }
    /**
     * @param {?} sourceImage
     * @param {?} options
     * @param {?} callback
     * @return {?}
     */
    static compressImage(sourceImage, options, callback) {
        /** @type {?} */
        let that = this;
        ImageUtilityService.createImage(sourceImage.imageDataUrl, function (image) {
            /** @type {?} */
            var dataURLcompressed = that.jicCompress(image, options);
            sourceImage.compressedImage = {
                fileName: sourceImage.fileName,
                imageObjectUrl: "",
                imageDataUrl: dataURLcompressed,
                type: dataURLcompressed.match(/:(.+\/.+);/)[1],
                compressedImage: null
            };
            callback(sourceImage);
        });
    }
    /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    static filesToCompressedImageSourceEx(fileList, option) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = fileList.length;
            /** @type {?} */
            let observer = ImageUtilityService.filesToSourceImages(fileList);
            /** @type {?} */
            let images = [];
            observer.subscribe((image) => {
                images.push(image);
                if (option == null) {
                    option = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, option, (imageRef) => {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, (error) => {
                reject("Error while compressing images");
            });
        });
    }
    /**
     * @param {?} fileList
     * @return {?}
     */
    static filesToCompressedImageSource(fileList) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = fileList.length;
            /** @type {?} */
            let observer = ImageUtilityService.filesToSourceImages(fileList);
            /** @type {?} */
            let images = [];
            observer.subscribe((image) => {
                images.push(image);
                ImageCompressService.compressImage(image, new ResizeOptions(), (imageRef) => {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, (error) => {
                reject("Error while compressing images");
            });
        });
    }
    /**
     * @param {?} fileList
     * @param {?} option
     * @return {?}
     */
    static filesArrayToCompressedImageSourceEx(fileList, option) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = fileList.length;
            /** @type {?} */
            let observer = ImageUtilityService.filesArrayToSourceImages(fileList);
            /** @type {?} */
            let images = [];
            observer.subscribe((image) => {
                images.push(image);
                if (option == null) {
                    option = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, option, (imageRef) => {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, (error) => {
                reject("Error while compressing images");
            });
        });
    }
    /**
     * @param {?} fileList
     * @return {?}
     */
    static filesArrayToCompressedImageSource(fileList) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = fileList.length;
            /** @type {?} */
            let observer = ImageUtilityService.filesArrayToSourceImages(fileList);
            /** @type {?} */
            let images = [];
            observer.subscribe((image) => {
                images.push(image);
                ImageCompressService.compressImage(image, new ResizeOptions(), (imageRef) => {
                    if (--count == 0) {
                        resolve(Observablefrom(images));
                    }
                });
            }, (error) => {
                reject("Error while compressing images");
            });
        });
    }
    /**
     * @param {?} images
     * @return {?}
     */
    static IImageListToCompressedImageSource(images) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = images.length;
            images.forEach(image => {
                ImageCompressService.compressImage(image, new ResizeOptions(), (imageRef) => {
                    console.log(image);
                    if (--count == 0) {
                        resolve(images);
                    }
                });
            });
        });
    }
    /**
     * @param {?} images
     * @param {?} resizeOption
     * @return {?}
     */
    static IImageListToCompressedImageSourceEx(images, resizeOption) {
        return new Promise((resolve, reject) => {
            /** @type {?} */
            let count = images.length;
            images.forEach(image => {
                if (resizeOption == null) {
                    resizeOption = new ResizeOptions();
                }
                ImageCompressService.compressImage(image, resizeOption, (imageRef) => {
                    console.log(image);
                    if (--count == 0) {
                        resolve(images);
                    }
                });
            });
        });
    }
}
ImageCompressService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
/** @nocollapse */ ImageCompressService.ngInjectableDef = i0.defineInjectable({ factory: function ImageCompressService_Factory() { return new ImageCompressService(); }, token: ImageCompressService, providedIn: "root" });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmcyLWltYWdlLWNvbXByZXNzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZzItaW1hZ2UtY29tcHJlc3MvIiwic291cmNlcyI6WyJsaWIvbmcyLWltYWdlLWNvbXByZXNzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRS9DLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBRTVELE9BQU8sRUFBRSxJQUFJLElBQUksY0FBYyxFQUFDLE1BQU0sTUFBTSxDQUFDOztBQU03QyxNQUFNLE9BQU8sb0JBQW9COzs7Ozs7O0lBSXZCLE1BQU0sQ0FBQyxXQUFXLENBQUMsWUFBWSxFQUFFLE9BQXNCOztZQUN2RCxZQUFZLEdBQUcsT0FBTyxDQUFDLFdBQVc7O1lBQ2xDLE9BQU8sR0FBRyxPQUFPLENBQUMsY0FBYyxJQUFJLEVBQUU7O1lBQ3RDLFFBQVEsR0FBRyxZQUFZO1FBQzNCLElBQUksWUFBWSxLQUFLLFNBQVMsSUFBSSxZQUFZLEtBQUssS0FBSyxFQUFFO1lBQ3RELFFBQVEsR0FBRyxXQUFXLENBQUM7U0FDMUI7O1lBR0csU0FBUyxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsSUFBSSxHQUFHOztZQUM1QyxRQUFRLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixJQUFJLEdBQUc7UUFFOUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQ2xDLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFDdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN0QyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMs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QyxNQUFnQixFQUFFLFlBQTJCO1FBQzNGLE9BQU8sSUFBSSxPQUFPLENBQVcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7O2dCQUN6QyxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU07WUFDekIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDbkIsSUFBSSxZQUFZLElBQUksSUFBSSxFQUFFO29CQUN0QixZQUFZLEdBQUcsSUFBSSxhQUFhLEVBQUUsQ0FBQztpQkFDdEM7Z0JBQ0Qsb0JBQW9CLENBQUMsYUFBYSxDQUFDLEtBQUssRUFBRSxZQUFZLEVBQUUsQ0FBQyxRQUFRLEVBQUUsRUFBRTtvQkFDakUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDbkIsSUFBSSxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUU7d0JBQ2QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO3FCQUNuQjtnQkFDTCxDQUFDLENBQUMsQ0FBQztZQUNQLENBQUMsQ0FBQyxDQUFDO1FBRVAsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDOzs7WUE5TEYsVUFBVSxTQUFDO2dCQUNWLFVBQVUsRUFBRSxNQUFNO2FBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnOyBcbmltcG9ydCB7IFJlc2l6ZU9wdGlvbnMgfSBmcm9tIFwiLi9SZXNpemVPcHRpb25zXCJcbmltcG9ydCB7IFNvdXJjZUltYWdlLCBJSW1hZ2UgfSBmcm9tIFwiLi9Db21wcmVzc0ltYWdlXCI7XG5pbXBvcnQgeyBJbWFnZVV0aWxpdHlTZXJ2aWNlIH0gZnJvbSBcIi4vaW1hZ2VVdGlsaXR5U2VydmljZVwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzXCIgXG5pbXBvcnQgeyBmcm9tIGFzIE9ic2VydmFibGVmcm9tfSBmcm9tIFwicnhqc1wiO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcblxuZXhwb3J0IGNsYXNzIEltYWdlQ29tcHJlc3NTZXJ2aWNlIHtcblxuICBcblxuICBwcml2YXRlIHN0YXRpYyBqaWNDb21wcmVzcyhzb3VyY2VJbWdPYmosIG9wdGlvbnM6IFJlc2l6ZU9wdGlvbnMpIHtcbiAgICAgIHZhciBvdXRwdXRGb3JtYXQgPSBvcHRpb25zLlJlc2l6ZV9UeXBlO1xuICAgICAgdmFyIHF1YWxpdHkgPSBvcHRpb25zLlJlc2l6ZV9RdWFsaXR5IHx8IDUwO1xuICAgICAgdmFyIG1pbWVUeXBlID0gJ2ltYWdlL2pwZWcnO1xuICAgICAgaWYgKG91dHB1dEZvcm1hdCAhPT0gdW5kZWZpbmVkICYmIG91dHB1dEZvcm1hdCA9PT0gJ3BuZycpIHtcbiAgICAgICAgICBtaW1lVHlwZSA9ICdpbWFnZS9wbmcnO1xuICAgICAgfVxuXG5cbiAgICAgIHZhciBtYXhIZWlnaHQgPSBvcHRpb25zLlJlc2l6ZV9NYXhfSGVpZ2h0IHx8IDMwMDtcbiAgICAgIHZhciBtYXhXaWR0aCA9IG9wdGlvbnMuUmVzaXplX01heF9XaWR0aCB8fCAyNTA7XG5cbiAgICAgIGNvbnNvbGUubG9nKCdNQVggV2lkdGggbiBIZWlnaHQnKTtcbiAgICAgIGNvbnNvbGUubG9nKG9wdGlvbnMuUmVzaXplX01heF9IZWlnaHQpO1xuICAgICAgY29uc29sZS5sb2cob3B0aW9ucy5SZXNpemVfTWF4X1dpZHRoKTtcbiAgICAgIGNvbnNvbGUubG9nKCdRdWFsaXR5Jyk7XG4gICAgICBjb25zb2xlLmxvZyhxdWFsaXR5KTtcblxuICAgICAgdmFyIGhlaWdodCA9IHNvdXJjZUltZ09iai5oZWlnaHQ7XG4gICAgICB2YXIgd2lkdGggPSBzb3VyY2VJbWdPYmoud2lkdGg7XG5cbiAgICAgIC8vIGNhbGN1bGF0ZSB0aGUgd2lkdGggYW5kIGhlaWdodCwgY29uc3RyYWluaW5nIHRoZSBwcm9wb3J0aW9uc1xuICAgICAgaWYgKHdpZHRoID4gaGVpZ2h0KSB7XG4gICAgICAgICAgaWYgKHdpZHRoID4gbWF4V2lkdGgpIHtcbiAgICAgICAgICAgICAgaGVpZ2h0ID0gTWF0aC5yb3VuZChoZWlnaHQgKj0gbWF4V2lkdGggLyB3aWR0aCk7XG4gICAgICAgICAgICAgIHdpZHRoID0gbWF4V2lkdGg7XG4gICAgICAgICAgfVxuICAgICAgfVxuICAgICAgZWxzZSB7XG4gICAgICAgICAgaWYgKGhlaWdodCA+IG1heEhlaWdodCkge1xuICAgICAgICAgICAgICB3aWR0aCA9IE1hdGgucm91bmQod2lkdGggKj0gbWF4SGVpZ2h0IC8gaGVpZ2h0KTtcbiAgICAgICAgICAgICAgaGVpZ2h0ID0gbWF4SGVpZ2h0O1xuICAgICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnNvbGUubG9nKCdDVlMgV2lkdGggbiBIZWlnaHQnKTtcbiAgICAgIGNvbnNvbGUubG9nKHdpZHRoKTtcbiAgICAgIGNvbnNvbGUubG9nKGhlaWdodCk7XG4gICAgICBjb25zb2xlLmxvZygnUXVhbGl0eScpO1xuICAgICAgY29uc29sZS5sb2cocXVhbGl0eSk7XG5cbiAgICAgIHZhciBjdnMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdjYW52YXMnKTtcbiAgICAgIGN2cy53aWR0aCA9IHdpZHRoO1xuICAgICAgY3ZzLmhlaWdodCA9IGhlaWdodDtcbiAgICAgIHZhciBjdHggPSBjdnMuZ2V0Q29udGV4dCgnMmQnKS5kcmF3SW1hZ2Uoc291cmNlSW1nT2JqLCAwLCAwLCB3aWR0aCwgaGVpZ2h0KTtcbiAgICAgIHZhciBuZXdJbWFnZURhdGEgPSBjdnMudG9EYXRhVVJMKG1pbWVUeXBlLCBxdWFsaXR5IC8gMTAwKTtcbiAgICAgIHZhciByZXN1bHRJbWFnZU9iaiA9IG5ldyBJbWFnZSgpO1xuICAgICAgcmVzdWx0SW1hZ2VPYmouc3JjID0gbmV3SW1hZ2VEYXRhO1xuICAgICAgcmV0dXJuIHJlc3VsdEltYWdlT2JqLnNyYztcbiAgfVxuXG4gICBcblxuICBwdWJsaWMgc3RhdGljIGNvbXByZXNzSW1hZ2Uoc291cmNlSW1hZ2U6IElJbWFnZSwgb3B0aW9uczogUmVzaXplT3B0aW9ucywgY2FsbGJhY2spIHtcbiAgICAgIGxldCB0aGF0ID0gdGhpcztcbiAgICAgIEltYWdlVXRpbGl0eVNlcnZpY2UuY3JlYXRlSW1hZ2Uoc291cmNlSW1hZ2UuaW1hZ2VEYXRhVXJsLCBmdW5jdGlvbiAoaW1hZ2UpIHtcbiAgICAgICAgICB2YXIgZGF0YVVSTGNvbXByZXNzZWQgPSB0aGF0LmppY0NvbXByZXNzKGltYWdlLCBvcHRpb25zKTtcbiAgICAgICAgICBzb3VyY2VJbWFnZS5jb21wcmVzc2VkSW1hZ2UgPSB7XG4gICAgICAgICAgICAgIGZpbGVOYW1lOiBzb3VyY2VJbWFnZS5maWxlTmFtZSxcbiAgICAgICAgICAgICAgaW1hZ2VPYmplY3RVcmw6IFwiXCIsXG4gICAgICAgICAgICAgIGltYWdlRGF0YVVybDogZGF0YVVSTGNvbXByZXNzZWQsXG4gICAgICAgICAgICAgIHR5cGU6IGRhdGFVUkxjb21wcmVzc2VkLm1hdGNoKC86KC4rXFwvLispOy8pWzFdLFxuICAgICAgICAgICAgICBjb21wcmVzc2VkSW1hZ2U6IG51bGxcbiAgICAgICAgICB9O1xuICAgICAgICAgIGNhbGxiYWNrKHNvdXJjZUltYWdlKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBmaWxlc1RvQ29tcHJlc3NlZEltYWdlU291cmNlRXgoZmlsZUxpc3Q6IEZpbGVMaXN0LCBvcHRpb246IFJlc2l6ZU9wdGlvbnMpOiBQcm9taXNlPE9ic2VydmFibGU8SUltYWdlPj4ge1xuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8T2JzZXJ2YWJsZTxJSW1hZ2U+PigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgbGV0IGNvdW50ID0gZmlsZUxpc3QubGVuZ3RoO1xuICAgICAgICAgIGxldCBvYnNlcnZlciA9IEltYWdlVXRpbGl0eVNlcnZpY2UuZmlsZXNUb1NvdXJjZUltYWdlcyhmaWxlTGlzdCk7XG4gICAgICAgICAgbGV0IGltYWdlczogQXJyYXk8SUltYWdlPiA9IFtdO1xuICAgICAgICAgIG9ic2VydmVyLnN1YnNjcmliZSgoaW1hZ2UpID0+IHtcbiAgICAgICAgICAgICAgaW1hZ2VzLnB1c2goaW1hZ2UpO1xuICAgICAgICAgICAgICBpZiAob3B0aW9uID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIG9wdGlvbiA9IG5ldyBSZXNpemVPcHRpb25zKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgb3B0aW9uLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKE9ic2VydmFibGVmcm9tKGltYWdlcykpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICAgICAgcmVqZWN0KFwiRXJyb3Igd2hpbGUgY29tcHJlc3NpbmcgaW1hZ2VzXCIpO1xuICAgICAgICAgIH0pXG4gICAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZmlsZXNUb0NvbXByZXNzZWRJbWFnZVNvdXJjZShmaWxlTGlzdDogRmlsZUxpc3QpOiBQcm9taXNlPE9ic2VydmFibGU8SUltYWdlPj4ge1xuXG5cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBsZXQgY291bnQgPSBmaWxlTGlzdC5sZW5ndGg7XG4gICAgICAgICAgbGV0IG9ic2VydmVyID0gSW1hZ2VVdGlsaXR5U2VydmljZS5maWxlc1RvU291cmNlSW1hZ2VzKGZpbGVMaXN0KTtcbiAgICAgICAgICBsZXQgaW1hZ2VzOiBBcnJheTxJSW1hZ2U+ID0gW107XG4gICAgICAgICAgb2JzZXJ2ZXIuc3Vic2NyaWJlKChpbWFnZSkgPT4ge1xuICAgICAgICAgICAgICBpbWFnZXMucHVzaChpbWFnZSk7XG5cbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgbmV3IFJlc2l6ZU9wdGlvbnMoKSwgKGltYWdlUmVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoLS1jb3VudCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShPYnNlcnZhYmxlZnJvbShpbWFnZXMpKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIHJlamVjdChcIkVycm9yIHdoaWxlIGNvbXByZXNzaW5nIGltYWdlc1wiKTtcbiAgICAgICAgICB9KVxuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGZpbGVzQXJyYXlUb0NvbXByZXNzZWRJbWFnZVNvdXJjZUV4KGZpbGVMaXN0OiBGaWxlW10sIG9wdGlvbjogUmVzaXplT3B0aW9ucyk6IFByb21pc2U8T2JzZXJ2YWJsZTxJSW1hZ2U+PiB7XG5cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBsZXQgY291bnQgPSBmaWxlTGlzdC5sZW5ndGg7XG4gICAgICAgICAgbGV0IG9ic2VydmVyID0gSW1hZ2VVdGlsaXR5U2VydmljZS5maWxlc0FycmF5VG9Tb3VyY2VJbWFnZXMoZmlsZUxpc3QpO1xuICAgICAgICAgIGxldCBpbWFnZXM6IEFycmF5PElJbWFnZT4gPSBbXTtcbiAgICAgICAgICBvYnNlcnZlci5zdWJzY3JpYmUoKGltYWdlKSA9PiB7XG4gICAgICAgICAgICAgIGltYWdlcy5wdXNoKGltYWdlKTtcbiAgICAgICAgICAgICAgaWYgKG9wdGlvbiA9PSBudWxsKSB7XG4gICAgICAgICAgICAgICAgICBvcHRpb24gPSBuZXcgUmVzaXplT3B0aW9ucygpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIEltYWdlQ29tcHJlc3NTZXJ2aWNlLmNvbXByZXNzSW1hZ2UoaW1hZ2UsIG9wdGlvbiwgKGltYWdlUmVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoLS1jb3VudCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShPYnNlcnZhYmxlZnJvbShpbWFnZXMpKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIHJlamVjdChcIkVycm9yIHdoaWxlIGNvbXByZXNzaW5nIGltYWdlc1wiKTtcbiAgICAgICAgICB9KVxuICAgICAgfSk7XG4gIH1cbiAgcHVibGljIHN0YXRpYyBmaWxlc0FycmF5VG9Db21wcmVzc2VkSW1hZ2VTb3VyY2UoZmlsZUxpc3Q6IEZpbGVbXSk6IFByb21pc2U8T2JzZXJ2YWJsZTxJSW1hZ2U+PiB7XG5cbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxPYnNlcnZhYmxlPElJbWFnZT4+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBsZXQgY291bnQgPSBmaWxlTGlzdC5sZW5ndGg7XG4gICAgICAgICAgbGV0IG9ic2VydmVyID0gSW1hZ2VVdGlsaXR5U2VydmljZS5maWxlc0FycmF5VG9Tb3VyY2VJbWFnZXMoZmlsZUxpc3QpO1xuICAgICAgICAgIGxldCBpbWFnZXM6IEFycmF5PElJbWFnZT4gPSBbXTtcbiAgICAgICAgICBvYnNlcnZlci5zdWJzY3JpYmUoKGltYWdlKSA9PiB7XG4gICAgICAgICAgICAgIGltYWdlcy5wdXNoKGltYWdlKTtcbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgbmV3IFJlc2l6ZU9wdGlvbnMoKSwgKGltYWdlUmVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBpZiAoLS1jb3VudCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShPYnNlcnZhYmxlZnJvbShpbWFnZXMpKTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgIHJlamVjdChcIkVycm9yIHdoaWxlIGNvbXByZXNzaW5nIGltYWdlc1wiKTtcbiAgICAgICAgICB9KVxuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIElJbWFnZUxpc3RUb0NvbXByZXNzZWRJbWFnZVNvdXJjZShpbWFnZXM6IElJbWFnZVtdKTogUHJvbWlzZTxJSW1hZ2VbXT4ge1xuXG4gICAgICByZXR1cm4gbmV3IFByb21pc2U8SUltYWdlW10+KChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICBsZXQgY291bnQgPSBpbWFnZXMubGVuZ3RoO1xuICAgICAgICAgIGltYWdlcy5mb3JFYWNoKGltYWdlID0+IHtcbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgbmV3IFJlc2l6ZU9wdGlvbnMoKSwgKGltYWdlUmVmKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhpbWFnZSk7XG4gICAgICAgICAgICAgICAgICBpZiAoLS1jb3VudCA9PSAwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShpbWFnZXMpO1xuICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICB9KTtcblxuICAgICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIElJbWFnZUxpc3RUb0NvbXByZXNzZWRJbWFnZVNvdXJjZUV4KGltYWdlczogSUltYWdlW10sIHJlc2l6ZU9wdGlvbjogUmVzaXplT3B0aW9ucyk6IFByb21pc2U8SUltYWdlW10+IHtcbiAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxJSW1hZ2VbXT4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgIGxldCBjb3VudCA9IGltYWdlcy5sZW5ndGg7XG4gICAgICAgICAgaW1hZ2VzLmZvckVhY2goaW1hZ2UgPT4ge1xuICAgICAgICAgICAgICBpZiAocmVzaXplT3B0aW9uID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgIHJlc2l6ZU9wdGlvbiA9IG5ldyBSZXNpemVPcHRpb25zKCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgSW1hZ2VDb21wcmVzc1NlcnZpY2UuY29tcHJlc3NJbWFnZShpbWFnZSwgcmVzaXplT3B0aW9uLCAoaW1hZ2VSZWYpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGltYWdlKTtcbiAgICAgICAgICAgICAgICAgIGlmICgtLWNvdW50ID09IDApIHtcbiAgICAgICAgICAgICAgICAgICAgICByZXNvbHZlKGltYWdlcyk7XG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pO1xuXG4gICAgICB9KTtcbiAgfVxuXG59XG5cbiJdfQ==